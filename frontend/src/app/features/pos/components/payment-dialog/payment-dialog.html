<p-dialog
  header="Payment"
  [(visible)]="visible"
  [modal]="true"
  [style]="{ width: '520px' }"
  [closable]="!processing()"
  [closeOnEscape]="!processing()"
  (onHide)="onClose()"
  (onShow)="onDialogShow()"
>
  <div class="payment-body">
    <div class="payment-method-tabs">
      @for (method of paymentMethods; track method.value) {
        <button
          class="method-tab"
          [class.active]="cart.paymentMethod() === method.value"
          (click)="selectPaymentMethod(method.value)"
          type="button"
        >
          <i [class]="method.icon"></i>
          <span>{{ method.label }}</span>
        </button>
      }
    </div>

    <div class="payment-total">
      <span>Total Amount</span>
      <span class="total-value">{{ totalAmount() | phpCurrency }}</span>
    </div>

    @if (isCash()) {
      <div class="field">
        <label>Amount Received</label>
        <p-inputNumber
          #amountInput
          [ngModel]="amountPaid()"
          (ngModelChange)="amountPaid.set($event)"
          (onInput)="onAmountInput($event)"
          mode="currency"
          currency="PHP"
          locale="en-PH"
          [min]="0"
          inputStyleClass="payment-input"
          styleClass="w-full"
          placeholder="Enter amount"
        />
      </div>

      <div class="numpad-grid">
        @for (key of numpadKeys; track key) {
          <button
            class="numpad-btn"
            [class.clear-btn]="key === 'C'"
            (click)="onNumpad(key)"
            type="button"
          >
            {{ key }}
          </button>
        }
      </div>

      <div class="quick-amounts">
        @for (amount of quickAmounts(); track amount) {
          <p-button
            [label]="amount | phpCurrency"
            [outlined]="true"
            severity="secondary"
            size="small"
            (onClick)="amountPaid.set(amount)"
          />
        }
      </div>

      <div class="change-display" [class.negative]="change() < 0">
        <span>{{ change() >= 0 ? 'Change' : 'Remaining' }}</span>
        <span class="change-value">{{ (change() >= 0 ? change() : -change()) | phpCurrency }}</span>
      </div>
    } @else {
      <div class="field">
        <label>Reference Number</label>
        <input
          type="text"
          pInputText
          [ngModel]="referenceNumber()"
          (ngModelChange)="referenceNumber.set($event)"
          placeholder="Enter reference / approval code"
          class="ref-input"
        />
        <!-- TODO: Store reference number when backend supports it -->
      </div>

      <div class="non-cash-note">
        <i class="pi pi-info-circle"></i>
        <span>{{ cart.paymentMethod() === 'gcash' ? 'GCash' : cart.paymentMethod() === 'maya' ? 'Maya' : 'Card' }} payment will be recorded as exact amount.</span>
      </div>
    }
  </div>

  <ng-template pTemplate="footer">
    <p-button
      label="Cancel"
      [text]="true"
      severity="secondary"
      [disabled]="processing()"
      (onClick)="onClose()"
    />
    <p-button
      [label]="processing() ? 'Processing...' : 'Complete Sale'"
      [icon]="processing() ? 'pi pi-spinner pi-spin' : 'pi pi-check'"
      [disabled]="(isCash() && change() < 0) || processing()"
      [loading]="processing()"
      (onClick)="onComplete()"
    />
  </ng-template>
</p-dialog>
