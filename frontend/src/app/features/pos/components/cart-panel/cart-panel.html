<div class="cart-panel">
  <div class="cart-header">
    <h3>Current Order</h3>
    @if (cart.items().length > 0) {
      <p-button
        label="Clear All"
        [text]="true"
        severity="danger"
        size="small"
        icon="pi pi-trash"
        (onClick)="cart.clear()"
      />
    }
  </div>

  <div class="cart-customer-row">
    @if (cart.customer()) {
      <div class="customer-chip">
        <i class="pi pi-user"></i>
        <span>{{ cart.customer()!.name }}</span>
        <button class="chip-remove" (click)="removeCustomer()" type="button">
          <i class="pi pi-times"></i>
        </button>
      </div>
    } @else {
      <button class="add-customer-btn" (click)="addCustomer.emit()" type="button">
        <i class="pi pi-user-plus"></i>
        <span>Add Customer</span>
      </button>
    }
  </div>

  <div class="cart-items">
    @if (cart.items().length === 0) {
      <div class="cart-empty">
        <i class="pi pi-shopping-cart"></i>
        <p>Cart is empty</p>
        <span class="cart-empty-hint">Tap a product to add it</span>
      </div>
    } @else {
      @for (item of cart.items(); track item.product.id) {
        <app-cart-item
          [item]="item"
          (quantityChanged)="cart.updateQuantity(item.product.id, $event)"
          (removed)="cart.removeItem(item.product.id)"
        />
      }
    }
  </div>

  @if (cart.items().length > 0) {
    <div class="cart-footer">
      <div class="discount-row">
        @if (cart.discountValue() > 0) {
          <div class="discount-chip">
            <i class="pi pi-tag"></i>
            <span>-{{ cart.discountValue() | phpCurrency }}</span>
            <button class="chip-remove" (click)="removeDiscount()" type="button">
              <i class="pi pi-times"></i>
            </button>
          </div>
        } @else {
          <button class="add-discount-btn" (click)="addDiscount.emit()" type="button">
            <i class="pi pi-tag"></i>
            <span>Add Discount</span>
          </button>
        }
      </div>

      <div class="cart-summary">
        <div class="summary-row">
          <span>Subtotal</span>
          <span>{{ cart.subtotal() | phpCurrency }}</span>
        </div>
        @if (cart.taxEnabled()) {
          <div class="summary-row">
            <span>VAT (12%)</span>
            <span>{{ cart.taxAmount() | phpCurrency }}</span>
          </div>
        }
        @if (cart.discountValue() > 0) {
          <div class="summary-row discount">
            <span>Discount</span>
            <span>-{{ cart.discountValue() | phpCurrency }}</span>
          </div>
        }
        <div class="summary-row total">
          <span>TOTAL</span>
          <span>{{ cart.total() | phpCurrency }}</span>
        </div>
        @if (getFifoMismatchCount() > 0) {
          <div class="fifo-cost-note">
            <i class="pi pi-info-circle"></i>
            <span>
              FIFO supplier cost basis applies to {{ getFifoMismatchCount() }} item(s). Selling prices are unchanged.
            </span>
          </div>
        }
      </div>

      <div class="payment-methods">
        @for (opt of paymentOptions; track opt.value) {
          <button
            class="payment-method-btn"
            [class.active]="cart.paymentMethod() === opt.value"
            (click)="cart.paymentMethod.set(opt.value)"
            type="button"
          >
            <i [class]="opt.icon"></i>
            <span>{{ opt.label }}</span>
          </button>
        }
      </div>

      <button class="charge-btn" (click)="charge.emit()" type="button">
        <i class="pi pi-wallet"></i>
        <span>CHARGE {{ cart.total() | phpCurrency }}</span>
      </button>
    </div>
  }
</div>
