<app-page-header title="Products" subtitle="Manage your product catalog">
      @if (storeCtx.isAdmin()) {
        <p-button label="Add Product" icon="pi pi-plus" (onClick)="openNew()" />
      }
    </app-page-header>

    <div class="card">
      <p-table
        [value]="products()"
        [paginator]="true"
        [rows]="15"
        [rowsPerPageOptions]="[15, 30, 50]"
        [globalFilterFields]="['name', 'sku', 'barcode']"
        [loading]="loading()"
        dataKey="id"
        [sortField]="'name'"
        [sortOrder]="1"
      >
        <ng-template pTemplate="header">
          <tr>
            <th pSortableColumn="name">Name <p-sortIcon field="name" /></th>
            <th pSortableColumn="sku">SKU <p-sortIcon field="sku" /></th>
            <th>Category</th>
            <th pSortableColumn="retail_price" style="text-align:right">Price <p-sortIcon field="retail_price" /></th>
            <th pSortableColumn="cost_price" style="text-align:right">Cost <p-sortIcon field="cost_price" /></th>
            <th pSortableColumn="current_stock" style="text-align:right">Stock <p-sortIcon field="current_stock" /></th>
            <th>Status</th>
            @if (storeCtx.isAdmin()) {
              <th style="width:100px">Actions</th>
            }
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-product>
          <tr>
            <td>
              <span class="font-medium">{{ product.name }}</span>
              @if (product.barcode) {
                <br><span class="text-xs text-secondary">{{ product.barcode }}</span>
              }
            </td>
            <td>{{ product.sku }}</td>
            <td>{{ product.category?.name ?? '-' }}</td>
            <td style="text-align:right">{{ product.retail_price | phpCurrency }}</td>
            <td style="text-align:right">{{ product.cost_price | phpCurrency }}</td>
            <td style="text-align:right" [class.text-danger]="product.current_stock <= product.reorder_level">
              {{ product.current_stock }} {{ product.unit }}
            </td>
            <td>
              <app-status-badge
                [label]="product.is_active ? 'Active' : 'Inactive'"
                [severity]="product.is_active ? 'success' : 'neutral'"
              />
            </td>
            @if (storeCtx.isAdmin()) {
              <td>
                <div class="flex gap-2">
                  <p-button icon="pi pi-pencil" [rounded]="true" [text]="true" severity="info" (onClick)="editProduct(product)" />
                  <p-button icon="pi pi-trash" [rounded]="true" [text]="true" severity="danger" (onClick)="confirmDelete(product)" />
                </div>
              </td>
            }
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr><td [attr.colspan]="storeCtx.isAdmin() ? 8 : 7" class="text-center text-secondary" style="padding:2rem">No products found</td></tr>
        </ng-template>
      </p-table>
    </div>

    <!-- Product Form Dialog -->
    <p-dialog
      [(visible)]="dialogVisible"
      [header]="editMode ? 'Edit Product' : 'New Product'"
      [modal]="true"
      [style]="{ width: '500px' }"
    >
      <div class="form-grid">
        <div class="field">
          <label>Name *</label>
          <input pInputText [(ngModel)]="form.name" class="w-full" />
        </div>
        <div class="field-row">
          <div class="field">
            <label>SKU *</label>
            <input pInputText [(ngModel)]="form.sku" class="w-full" />
          </div>
          <div class="field">
            <label>Barcode</label>
            <input pInputText [(ngModel)]="form.barcode" class="w-full" />
          </div>
        </div>
        <div class="field">
          <label>Category *</label>
          <p-select
            [(ngModel)]="form.category_id"
            [options]="categories()"
            optionLabel="name"
            optionValue="id"
            placeholder="Select category"
            styleClass="w-full"
            appendTo="body"
          />
        </div>
        <div class="field">
          <label>Description</label>
          <input pInputText [(ngModel)]="form.description" class="w-full" />
        </div>
        <div class="field-row">
          <div class="field">
            <label>Retail Price *</label>
            <p-inputNumber [(ngModel)]="form.retail_price" mode="currency" currency="PHP" locale="en-PH" styleClass="w-full" />
          </div>
          <div class="field">
            <label>Cost Price *</label>
            <p-inputNumber [(ngModel)]="form.cost_price" mode="currency" currency="PHP" locale="en-PH" styleClass="w-full" />
          </div>
        </div>
        @if (form.cost_price > 0 && form.retail_price > 0 && form.cost_price >= form.retail_price) {
          <small class="price-warning">
            <i class="pi pi-exclamation-triangle"></i>
            Cost price is higher than or equal to retail price. You may be selling at a loss.
          </small>
        }
        <div class="field-row">
          <div class="field">
            <label>Unit</label>
            <input pInputText [(ngModel)]="form.unit" class="w-full" placeholder="pcs" />
          </div>
          <div class="field">
            <label>Reorder Level</label>
            <p-inputNumber [(ngModel)]="form.reorder_level" [min]="0" styleClass="w-full" />
          </div>
        </div>
      </div>

      <ng-template pTemplate="footer">
        <p-button label="Cancel" [text]="true" severity="secondary" (onClick)="dialogVisible = false" />
        <p-button
          [label]="editMode ? 'Update' : 'Create'"
          icon="pi pi-check"
          (onClick)="saveProduct()"
          [loading]="saving()"
          [disabled]="!form.name || !form.sku || !form.category_id"
        />
      </ng-template>
    </p-dialog>
