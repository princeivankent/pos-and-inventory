<app-page-header title="Stock Movements" subtitle="Full history of inventory changes">
  <a routerLink="/inventory">
    <p-button label="Back to Inventory" icon="pi pi-arrow-left" severity="secondary" [outlined]="true" />
  </a>
</app-page-header>

<!-- Filter Bar -->
<div class="filter-bar">
  <div class="type-filters">
    @for (f of typeFilters; track f.value) {
      <button
        class="type-chip"
        [class.active]="activeTypeFilter === f.value"
        (click)="setTypeFilter(f.value)"
      >
        {{ f.label }}
      </button>
    }
  </div>
</div>

<!-- Table -->
<div class="card">
  <p-table
    [value]="movements()"
    [paginator]="true"
    [rows]="15"
    [rowsPerPageOptions]="[15, 30, 50]"
    [loading]="loading()"
    [lazy]="true"
    [totalRecords]="totalRecords()"
    (onLazyLoad)="onPageChange($event)"
    [showCurrentPageReport]="true"
    currentPageReportTemplate="Showing {first}–{last} of {totalRecords} movements"
    dataKey="id"
    styleClass="enhanced-table"
  >
    <ng-template pTemplate="header">
      <tr>
        <th style="width: 155px">Date & Time</th>
        <th>Product</th>
        <th style="width: 110px">Type</th>
        <th style="width: 80px; text-align: right">Qty</th>
        <th>Supplier</th>
        <th style="width: 120px">Batch #</th>
        <th>Notes</th>
        <th style="width: 120px">By</th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-m>
      <tr class="table-row">
        <!-- Date & Time -->
        <td class="cell-date">
          <span class="date">{{ m.created_at | date:'MMM d, y' }}</span>
          <span class="time">{{ m.created_at | date:'h:mm a' }}</span>
        </td>

        <!-- Product -->
        <td>
          <div class="cell-product">
            <span class="product-name">{{ m.batch?.product?.name ?? 'N/A' }}</span>
            @if (m.batch?.product?.sku) {
              <span class="product-sku">{{ m.batch?.product?.sku }}</span>
            }
          </div>
        </td>

        <!-- Type badge -->
        <td>
          <span class="type-badge {{ getTypeConfig(m.movement_type).cls }}">
            {{ getTypeConfig(m.movement_type).label }}
          </span>
        </td>

        <!-- Quantity -->
        <td class="cell-qty" [class.qty-positive]="m.quantity > 0" [class.qty-negative]="m.quantity < 0">
          {{ m.quantity > 0 ? '+' : '' }}{{ m.quantity }}
        </td>

        <!-- Supplier -->
        <td class="cell-secondary">
          {{ m.batch?.supplier?.name ?? '—' }}
        </td>

        <!-- Batch # -->
        <td class="cell-secondary cell-mono">
          {{ m.batch?.batch_number ?? '—' }}
        </td>

        <!-- Notes -->
        <td class="cell-secondary">
          {{ m.notes ?? '—' }}
        </td>

        <!-- By -->
        <td class="cell-secondary">
          {{ m.creator?.full_name ?? '—' }}
        </td>
      </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="8" class="empty-state">
          <div class="empty-content">
            <i class="pi pi-history"></i>
            <h3>No movements found</h3>
            <p>
              @if (activeTypeFilter) {
                No <strong>{{ getTypeConfig(activeTypeFilter).label }}</strong> movements recorded yet.
              } @else {
                Inventory movements will be tracked here as stock changes occur.
              }
            </p>
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>
</div>
