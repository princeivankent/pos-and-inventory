<app-page-header title="Inventory" subtitle="Stock levels and management">
      @if (storeCtx.isAdmin()) {
        <p-button label="Stock In" icon="pi pi-plus" (onClick)="openStockIn()" />
      }
      <a routerLink="/inventory/low-stock">
        <p-button label="Low Stock" icon="pi pi-exclamation-triangle" severity="warn" [outlined]="true" />
      </a>
      <a routerLink="/inventory/movements">
        <p-button label="Movements" icon="pi pi-history" severity="secondary" [outlined]="true" />
      </a>
    </app-page-header>

    <div class="card">
      <p-table
        [value]="products()"
        [paginator]="true"
        [rows]="20"
        [loading]="loading()"
        dataKey="id"
        [sortField]="'name'"
        [sortOrder]="1"
      >
        <ng-template pTemplate="header">
          <tr>
            <th pSortableColumn="name">Product <p-sortIcon field="name" /></th>
            <th>SKU</th>
            <th pSortableColumn="current_stock" style="text-align:right">Stock <p-sortIcon field="current_stock" /></th>
            <th style="text-align:right">Cost Value</th>
            <th style="text-align:right">Retail Value</th>
            <th>Status</th>
            @if (storeCtx.isAdmin()) {
              <th style="width:80px">Adjust</th>
            }
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-p>
          <tr>
            <td class="font-medium">{{ p.name }}</td>
            <td>{{ p.sku }}</td>
            <td style="text-align:right">{{ p.current_stock }} {{ p.unit }}</td>
            <td style="text-align:right">{{ p.current_stock * p.cost_price | phpCurrency }}</td>
            <td style="text-align:right">{{ p.current_stock * p.retail_price | phpCurrency }}</td>
            <td>
              @if (p.current_stock <= 0) {
                <app-status-badge label="Out of Stock" severity="danger" />
              } @else if (p.current_stock <= p.reorder_level) {
                <app-status-badge label="Low Stock" severity="warn" />
              } @else {
                <app-status-badge label="In Stock" severity="success" />
              }
            </td>
            @if (storeCtx.isAdmin()) {
              <td>
                <p-button icon="pi pi-sliders-h" [rounded]="true" [text]="true" (onClick)="openAdjust(p)" />
              </td>
            }
          </tr>
        </ng-template>
      </p-table>
    </div>

    <!-- Stock In Dialog -->
    <p-dialog
      [(visible)]="stockInVisible"
      header="Stock In"
      [modal]="true"
      [style]="{ width: '440px' }"
    >
      <div class="form-grid">
        <div class="field">
          <label>Product</label>
          <p-select
            [(ngModel)]="stockInForm.product_id"
            [options]="products()"
            optionLabel="name"
            optionValue="id"
            placeholder="Select a product"
            styleClass="w-full"
            [filter]="true"
            appendTo="body"
          />
        </div>
        <div class="field">
          <label>Quantity</label>
          <p-inputNumber [(ngModel)]="stockInForm.quantity" [min]="1" styleClass="w-full" />
        </div>
        <div class="field">
          <label>Unit Cost (optional)</label>
          <p-inputNumber [(ngModel)]="stockInForm.unit_cost" [min]="0" [minFractionDigits]="2" [maxFractionDigits]="2" styleClass="w-full" placeholder="Leave blank to use product cost price" />
        </div>
        <div class="field">
          <label>Notes</label>
          <input pInputText [(ngModel)]="stockInForm.notes" class="w-full" placeholder="e.g. Purchase from supplier" />
        </div>
      </div>

      <ng-template pTemplate="footer">
        <p-button label="Cancel" [text]="true" severity="secondary" (onClick)="stockInVisible = false" />
        <p-button label="Stock In" icon="pi pi-plus" (onClick)="applyStockIn()" [loading]="saving()" />
      </ng-template>
    </p-dialog>

    <!-- Stock Out / Adjustment Dialog -->
    <p-dialog
      [(visible)]="adjustVisible"
      header="Stock Adjustment"
      [modal]="true"
      [style]="{ width: '400px' }"
    >
      @if (adjustProduct) {
        <div class="form-grid">
          <p class="text-secondary text-sm">Adjusting: <strong>{{ adjustProduct.name }}</strong> (Current: {{ adjustProduct.current_stock }} {{ adjustProduct.unit }})</p>
          <div class="field">
            <label>Type</label>
            <p-select
              [(ngModel)]="adjustForm.type"
              [options]="adjustTypes"
              optionLabel="label"
              optionValue="value"
              styleClass="w-full"
              appendTo="body"
            />
          </div>
          <div class="field">
            <label>Quantity</label>
            <p-inputNumber [(ngModel)]="adjustForm.quantity" [min]="1" [max]="adjustProduct.current_stock" styleClass="w-full" />
          </div>
          <div class="field">
            <label>Notes</label>
            <input pInputText [(ngModel)]="adjustForm.notes" class="w-full" placeholder="Reason for adjustment" />
          </div>
        </div>
      }

      <ng-template pTemplate="footer">
        <p-button label="Cancel" [text]="true" severity="secondary" (onClick)="adjustVisible = false" />
        <p-button label="Apply" icon="pi pi-check" severity="danger" (onClick)="applyAdjustment()" [loading]="saving()" />
      </ng-template>
    </p-dialog>
