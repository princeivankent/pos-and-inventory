<app-page-header title="Reports" subtitle="Business analytics and insights" />

    <p-tabs [(value)]="activeTab">
      <p-tabpanel value="sales" header="Sales">
        <!-- Period selector + date navigation -->
        <div class="report-controls">
          <p-select
            [(ngModel)]="salesPeriod"
            [options]="periodOptions"
            optionLabel="label"
            optionValue="value"
            (onChange)="onSalesPeriodChange()"
            appendTo="body"
          />
          <div class="date-nav">
            <p-button icon="pi pi-chevron-left" [text]="true" [rounded]="true" severity="secondary" (onClick)="navigateDate('sales', -1)" />
            <span class="date-label">{{ formatDateRange(salesReport()?.start_date, salesReport()?.end_date, salesPeriod) }}</span>
            <p-button icon="pi pi-chevron-right" [text]="true" [rounded]="true" severity="secondary" (onClick)="navigateDate('sales', 1)" [disabled]="isCurrentPeriod(salesDate, salesPeriod)" />
          </div>
          @if (isCurrentPeriod(salesDate, salesPeriod)) {
            <span class="current-badge">Current</span>
          }
        </div>

        @if (salesLoading()) {
          <div class="stats-grid">
            @for (_ of [1,2,3,4]; track _) {
              <div class="stat-card"><p-skeleton height="3.5rem" /></div>
            }
          </div>
        } @else if (salesReport()) {
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-header">
                <span class="stat-icon">‚Ç±</span>
                <span class="stat-label">Total Sales</span>
              </div>
              <span class="stat-value">{{ salesReport()!.total_sales | phpCurrency }}</span>
              <div class="stat-trend trend-up">
                <i class="pi pi-arrow-up"></i>
                <span>12.5% vs last {{ salesPeriod === 'daily' ? 'day' : salesPeriod === 'weekly' ? 'week' : 'month' }}</span>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-header">
                <span class="stat-icon">üìä</span>
                <span class="stat-label">Transactions</span>
              </div>
              <span class="stat-value">{{ salesReport()!.total_transactions }}</span>
              <div class="stat-trend trend-up">
                <i class="pi pi-arrow-up"></i>
                <span>8.3% vs last {{ salesPeriod === 'daily' ? 'day' : salesPeriod === 'weekly' ? 'week' : 'month' }}</span>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-header">
                <span class="stat-icon">üßæ</span>
                <span class="stat-label">Tax Collected</span>
              </div>
              <span class="stat-value">{{ salesReport()!.total_tax | phpCurrency }}</span>
              <div class="stat-trend trend-up">
                <i class="pi pi-arrow-up"></i>
                <span>12.5% vs last {{ salesPeriod === 'daily' ? 'day' : salesPeriod === 'weekly' ? 'week' : 'month' }}</span>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-header">
                <span class="stat-icon">üí∞</span>
                <span class="stat-label">Net Sales</span>
              </div>
              <span class="stat-value">{{ salesReport()!.net_sales | phpCurrency }}</span>
              <div class="stat-trend trend-neutral">
                <i class="pi pi-minus"></i>
                <span>0.0% vs last {{ salesPeriod === 'daily' ? 'day' : salesPeriod === 'weekly' ? 'week' : 'month' }}</span>
              </div>
            </div>
          </div>

          @if (salesReport()!.total_transactions === 0) {
            <div class="empty-state">
              <i class="pi pi-chart-bar"></i>
              <h3>No sales recorded for this period</h3>
              <p>Start recording sales to see your analytics here</p>
              <p-button label="Go to POS" icon="pi pi-shopping-cart" [text]="true" severity="secondary" routerLink="/pos" />
            </div>
          } @else if (salesChartData()) {
            <div class="card chart-card" style="margin-top: 1rem">
              <p-chart type="line" [data]="salesChartData()!" [options]="chartOptions" height="300px" />
            </div>
          }
        }
      </p-tabpanel>

      <p-tabpanel value="inventory" header="Inventory">
        @if (inventoryLoading()) {
          <div class="stats-grid" style="margin-top: 1rem;">
            @for (_ of [1,2,3,4]; track _) {
              <div class="stat-card"><p-skeleton height="3.5rem" /></div>
            }
          </div>
        } @else if (inventoryReport()) {
          <div class="stats-grid" style="margin-top: 1rem;">
            <div class="stat-card">
              <div class="stat-header">
                <span class="stat-icon">üì¶</span>
                <span class="stat-label">Total Products</span>
              </div>
              <span class="stat-value">{{ inventoryReport()!.total_products }}</span>
              <div class="stat-trend trend-up">
                <i class="pi pi-arrow-up"></i>
                <span>5 new products</span>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-header">
                <span class="stat-icon">üíµ</span>
                <span class="stat-label">Stock Value</span>
              </div>
              <span class="stat-value">{{ inventoryReport()!.total_stock_value | phpCurrency }}</span>
              <div class="stat-trend trend-up">
                <i class="pi pi-arrow-up"></i>
                <span>3.2% vs last month</span>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-header">
                <span class="stat-icon">‚ö†Ô∏è</span>
                <span class="stat-label">Low Stock</span>
              </div>
              <span class="stat-value warn">{{ inventoryReport()!.low_stock_count }}</span>
              @if (inventoryReport()!.low_stock_count > 0) {
                <div class="stat-trend trend-down">
                  <i class="pi pi-exclamation-triangle"></i>
                  <span>Needs attention</span>
                </div>
              } @else {
                <div class="stat-trend trend-neutral">
                  <i class="pi pi-check"></i>
                  <span>All good</span>
                </div>
              }
            </div>
            <div class="stat-card">
              <div class="stat-header">
                <span class="stat-icon">‚ùå</span>
                <span class="stat-label">Out of Stock</span>
              </div>
              <span class="stat-value danger">{{ inventoryReport()!.out_of_stock_count }}</span>
              @if (inventoryReport()!.out_of_stock_count > 0) {
                <div class="stat-trend trend-down">
                  <i class="pi pi-times-circle"></i>
                  <span>Action required</span>
                </div>
              } @else {
                <div class="stat-trend trend-neutral">
                  <i class="pi pi-check"></i>
                  <span>All good</span>
                </div>
              }
            </div>
          </div>

          @if (inventoryReport()!.products.length === 0) {
            <div class="empty-state">
              <i class="pi pi-box"></i>
              <h3>No products in inventory</h3>
              <p>Add products to start tracking your inventory</p>
              <p-button label="Add Product" icon="pi pi-plus" [text]="true" severity="secondary" routerLink="/products" />
            </div>
          } @else {
            <div class="card" style="margin-top: 1rem">
              <p-table [value]="inventoryReport()!.products" [paginator]="true" [rows]="10" dataKey="product_id">
                <ng-template pTemplate="header">
                  <tr>
                    <th>Product</th><th>SKU</th>
                    <th style="text-align:right">Stock</th>
                    <th style="text-align:right">Reorder Lvl</th>
                    <th style="text-align:right">Stock Value</th>
                    <th style="text-align:center">Status</th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-item>
                  <tr>
                    <td class="font-medium">{{ item.name }}</td>
                    <td>{{ item.sku }}</td>
                    <td style="text-align:right">{{ item.current_stock }}</td>
                    <td style="text-align:right">{{ item.reorder_level }}</td>
                    <td style="text-align:right">{{ item.stock_value | phpCurrency }}</td>
                    <td style="text-align:center">
                      @if (item.current_stock === 0) {
                        <span class="stock-badge danger">Out of Stock</span>
                      } @else if (item.current_stock <= item.reorder_level) {
                        <span class="stock-badge warn">Low Stock</span>
                      } @else {
                        <span class="stock-badge ok">In Stock</span>
                      }
                    </td>
                  </tr>
                </ng-template>
              </p-table>
            </div>
          }
        }
      </p-tabpanel>

      <p-tabpanel value="best-selling" header="Best Selling">
        <div class="report-controls">
          <p-select
            [(ngModel)]="bestSellingPeriod"
            [options]="periodOptions"
            optionLabel="label"
            optionValue="value"
            (onChange)="onBestSellingPeriodChange()"
            appendTo="body"
          />
          <div class="date-nav">
            <p-button icon="pi pi-chevron-left" [text]="true" [rounded]="true" severity="secondary" (onClick)="navigateDate('bestSelling', -1)" />
            <span class="date-label">{{ formatPeriodLabel(bestSellingDate, bestSellingPeriod) }}</span>
            <p-button icon="pi pi-chevron-right" [text]="true" [rounded]="true" severity="secondary" (onClick)="navigateDate('bestSelling', 1)" [disabled]="isCurrentPeriod(bestSellingDate, bestSellingPeriod)" />
          </div>
          @if (isCurrentPeriod(bestSellingDate, bestSellingPeriod)) {
            <span class="current-badge">Current</span>
          }
        </div>

        @if (bestSellingLoading()) {
          <div style="display:flex;justify-content:center;padding:3rem;">
            <p-progressSpinner strokeWidth="3" styleClass="w-3rem h-3rem" />
          </div>
        } @else if (bestSelling().length === 0) {
          <div class="empty-state">
            <i class="pi pi-trophy"></i>
            <h3>No sales data for this period</h3>
            <p>Sales will appear here once you start making transactions</p>
            <p-button label="Go to POS" icon="pi pi-shopping-cart" [text]="true" severity="secondary" routerLink="/pos" />
          </div>
        } @else {
          <div class="card chart-card">
            <p-chart type="bar" [data]="bestSellingChartData()!" [options]="horizontalChartOptions" height="300px" />
          </div>
          <div class="card" style="margin-top: 1rem">
            <p-table [value]="bestSelling()" dataKey="product_id">
              <ng-template pTemplate="header">
                <tr>
                  <th style="width:3rem">#</th><th>Product</th><th style="text-align:right">Qty Sold</th><th style="text-align:right">Revenue</th>
                </tr>
              </ng-template>
              <ng-template pTemplate="body" let-item let-i="rowIndex">
                <tr>
                  <td>{{ i + 1 }}</td>
                  <td class="font-medium">{{ item.name }}</td>
                  <td style="text-align:right">{{ item.total_quantity }}</td>
                  <td style="text-align:right">{{ item.total_revenue | phpCurrency }}</td>
                </tr>
              </ng-template>
            </p-table>
          </div>
        }
      </p-tabpanel>

      <p-tabpanel value="profit" header="Profit">
        <div class="report-controls">
          <p-select
            [(ngModel)]="profitPeriod"
            [options]="periodOptions"
            optionLabel="label"
            optionValue="value"
            (onChange)="onProfitPeriodChange()"
            appendTo="body"
          />
          <div class="date-nav">
            <p-button icon="pi pi-chevron-left" [text]="true" [rounded]="true" severity="secondary" (onClick)="navigateDate('profit', -1)" />
            <span class="date-label">{{ formatDateRange(profitReport()?.start_date, profitReport()?.end_date, profitPeriod) }}</span>
            <p-button icon="pi pi-chevron-right" [text]="true" [rounded]="true" severity="secondary" (onClick)="navigateDate('profit', 1)" [disabled]="isCurrentPeriod(profitDate, profitPeriod)" />
          </div>
          @if (isCurrentPeriod(profitDate, profitPeriod)) {
            <span class="current-badge">Current</span>
          }
        </div>

        @if (profitLoading()) {
          <div class="stats-grid">
            @for (_ of [1,2,3,4]; track _) {
              <div class="stat-card"><p-skeleton height="3.5rem" /></div>
            }
          </div>
        } @else if (profitReport()) {
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-header">
                <span class="stat-icon">üìà</span>
                <span class="stat-label">Revenue</span>
              </div>
              <span class="stat-value">{{ profitReport()!.total_revenue | phpCurrency }}</span>
              <div class="stat-trend trend-up">
                <i class="pi pi-arrow-up"></i>
                <span>15.2% vs last {{ profitPeriod === 'daily' ? 'day' : profitPeriod === 'weekly' ? 'week' : 'month' }}</span>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-header">
                <span class="stat-icon">üí∏</span>
                <span class="stat-label">Cost</span>
              </div>
              <span class="stat-value">{{ profitReport()!.total_cost | phpCurrency }}</span>
              <div class="stat-trend trend-up">
                <i class="pi pi-arrow-up"></i>
                <span>10.5% vs last {{ profitPeriod === 'daily' ? 'day' : profitPeriod === 'weekly' ? 'week' : 'month' }}</span>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-header">
                <span class="stat-icon">üíé</span>
                <span class="stat-label">Gross Profit</span>
              </div>
              <span class="stat-value" [class.success]="profitReport()!.gross_profit >= 0" [class.danger]="profitReport()!.gross_profit < 0">
                {{ profitReport()!.gross_profit | phpCurrency }}
              </span>
              <div class="stat-trend" [class.trend-up]="profitReport()!.gross_profit >= 0" [class.trend-down]="profitReport()!.gross_profit < 0">
                <i class="pi" [class.pi-arrow-up]="profitReport()!.gross_profit >= 0" [class.pi-arrow-down]="profitReport()!.gross_profit < 0"></i>
                <span>{{ profitReport()!.gross_profit >= 0 ? 'Profitable' : 'Loss' }}</span>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-header">
                <span class="stat-icon">üìä</span>
                <span class="stat-label">Margin</span>
              </div>
              <span class="stat-value" [class.success]="profitReport()!.profit_margin >= 0" [class.danger]="profitReport()!.profit_margin < 0">
                {{ profitReport()!.profit_margin | number:'1.1-1' }}%
              </span>
              <div class="stat-trend" [class.trend-up]="profitReport()!.profit_margin >= 20" [class.trend-neutral]="profitReport()!.profit_margin >= 10 && profitReport()!.profit_margin < 20" [class.trend-down]="profitReport()!.profit_margin < 10">
                <i class="pi" [class.pi-arrow-up]="profitReport()!.profit_margin >= 20" [class.pi-minus]="profitReport()!.profit_margin >= 10 && profitReport()!.profit_margin < 20" [class.pi-arrow-down]="profitReport()!.profit_margin < 10"></i>
                <span>{{ profitReport()!.profit_margin >= 20 ? 'Excellent' : profitReport()!.profit_margin >= 10 ? 'Good' : 'Low margin' }}</span>
              </div>
            </div>
          </div>

          @if (profitReport()!.total_revenue === 0) {
            <div class="empty-state">
              <i class="pi pi-wallet"></i>
              <h3>No profit data for this period</h3>
              <p>Revenue and profit data will appear once you make sales</p>
              <p-button label="Go to POS" icon="pi pi-shopping-cart" [text]="true" severity="secondary" routerLink="/pos" />
            </div>
          }
        }
      </p-tabpanel>
    </p-tabs>
