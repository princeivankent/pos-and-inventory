<app-page-header title="Reports" subtitle="Business analytics and insights" />

    <p-tabs [(value)]="activeTab">
      <p-tabpanel value="sales" header="Sales">
        <!-- Period selector + date navigation -->
        <div class="report-controls">
          <p-select
            [(ngModel)]="salesPeriod"
            [options]="periodOptions"
            optionLabel="label"
            optionValue="value"
            (onChange)="onSalesPeriodChange()"
            appendTo="body"
          />
          <div class="date-nav">
            <p-button icon="pi pi-chevron-left" [text]="true" [rounded]="true" severity="secondary" (onClick)="navigateDate('sales', -1)" />
            <span class="date-label">{{ formatDateRange(salesReport()?.start_date, salesReport()?.end_date, salesPeriod) }}</span>
            <p-button icon="pi pi-chevron-right" [text]="true" [rounded]="true" severity="secondary" (onClick)="navigateDate('sales', 1)" [disabled]="isCurrentPeriod(salesDate, salesPeriod)" />
          </div>
          @if (isCurrentPeriod(salesDate, salesPeriod)) {
            <span class="current-badge">Current</span>
          }
        </div>

        @if (salesLoading()) {
          <div class="stats-grid">
            @for (_ of [1,2,3,4]; track _) {
              <div class="stat-card"><p-skeleton height="3.5rem" /></div>
            }
          </div>
        } @else if (salesReport()) {
          <div class="stats-grid">
            <div class="stat-card">
              <span class="stat-label">Total Sales</span>
              <span class="stat-value">{{ salesReport()!.total_sales | phpCurrency }}</span>
            </div>
            <div class="stat-card">
              <span class="stat-label">Transactions</span>
              <span class="stat-value">{{ salesReport()!.total_transactions }}</span>
            </div>
            <div class="stat-card">
              <span class="stat-label">Tax Collected</span>
              <span class="stat-value">{{ salesReport()!.total_tax | phpCurrency }}</span>
            </div>
            <div class="stat-card">
              <span class="stat-label">Net Sales</span>
              <span class="stat-value">{{ salesReport()!.net_sales | phpCurrency }}</span>
            </div>
          </div>

          @if (salesReport()!.total_transactions === 0) {
            <div class="empty-state">
              <i class="pi pi-chart-bar"></i>
              <p>No sales recorded for this period</p>
            </div>
          } @else if (salesChartData()) {
            <div class="card" style="margin-top: 1rem">
              <p-chart type="bar" [data]="salesChartData()!" [options]="chartOptions" height="300px" />
            </div>
          }
        }
      </p-tabpanel>

      <p-tabpanel value="inventory" header="Inventory">
        @if (inventoryLoading()) {
          <div class="stats-grid" style="margin-top: 1rem;">
            @for (_ of [1,2,3,4]; track _) {
              <div class="stat-card"><p-skeleton height="3.5rem" /></div>
            }
          </div>
        } @else if (inventoryReport()) {
          <div class="stats-grid" style="margin-top: 1rem;">
            <div class="stat-card">
              <span class="stat-label">Total Products</span>
              <span class="stat-value">{{ inventoryReport()!.total_products }}</span>
            </div>
            <div class="stat-card">
              <span class="stat-label">Stock Value</span>
              <span class="stat-value">{{ inventoryReport()!.total_stock_value | phpCurrency }}</span>
            </div>
            <div class="stat-card">
              <span class="stat-label">Low Stock</span>
              <span class="stat-value warn">{{ inventoryReport()!.low_stock_count }}</span>
            </div>
            <div class="stat-card">
              <span class="stat-label">Out of Stock</span>
              <span class="stat-value danger">{{ inventoryReport()!.out_of_stock_count }}</span>
            </div>
          </div>

          @if (inventoryReport()!.products.length === 0) {
            <div class="empty-state">
              <i class="pi pi-box"></i>
              <p>No products in inventory</p>
            </div>
          } @else {
            <div class="card" style="margin-top: 1rem">
              <p-table [value]="inventoryReport()!.products" [paginator]="true" [rows]="10" dataKey="product_id">
                <ng-template pTemplate="header">
                  <tr>
                    <th>Product</th><th>SKU</th>
                    <th style="text-align:right">Stock</th>
                    <th style="text-align:right">Reorder Lvl</th>
                    <th style="text-align:right">Stock Value</th>
                    <th style="text-align:center">Status</th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-item>
                  <tr>
                    <td class="font-medium">{{ item.name }}</td>
                    <td>{{ item.sku }}</td>
                    <td style="text-align:right">{{ item.current_stock }}</td>
                    <td style="text-align:right">{{ item.reorder_level }}</td>
                    <td style="text-align:right">{{ item.stock_value | phpCurrency }}</td>
                    <td style="text-align:center">
                      @if (item.current_stock === 0) {
                        <span class="stock-badge danger">Out of Stock</span>
                      } @else if (item.current_stock <= item.reorder_level) {
                        <span class="stock-badge warn">Low Stock</span>
                      } @else {
                        <span class="stock-badge ok">In Stock</span>
                      }
                    </td>
                  </tr>
                </ng-template>
              </p-table>
            </div>
          }
        }
      </p-tabpanel>

      <p-tabpanel value="best-selling" header="Best Selling">
        <div class="report-controls">
          <p-select
            [(ngModel)]="bestSellingPeriod"
            [options]="periodOptions"
            optionLabel="label"
            optionValue="value"
            (onChange)="onBestSellingPeriodChange()"
            appendTo="body"
          />
          <div class="date-nav">
            <p-button icon="pi pi-chevron-left" [text]="true" [rounded]="true" severity="secondary" (onClick)="navigateDate('bestSelling', -1)" />
            <span class="date-label">{{ formatPeriodLabel(bestSellingDate, bestSellingPeriod) }}</span>
            <p-button icon="pi pi-chevron-right" [text]="true" [rounded]="true" severity="secondary" (onClick)="navigateDate('bestSelling', 1)" [disabled]="isCurrentPeriod(bestSellingDate, bestSellingPeriod)" />
          </div>
          @if (isCurrentPeriod(bestSellingDate, bestSellingPeriod)) {
            <span class="current-badge">Current</span>
          }
        </div>

        @if (bestSellingLoading()) {
          <div style="display:flex;justify-content:center;padding:3rem;">
            <p-progressSpinner strokeWidth="3" styleClass="w-3rem h-3rem" />
          </div>
        } @else if (bestSelling().length === 0) {
          <div class="empty-state">
            <i class="pi pi-trophy"></i>
            <p>No sales data for this period</p>
          </div>
        } @else {
          <div class="card">
            <p-chart type="bar" [data]="bestSellingChartData()!" [options]="horizontalChartOptions" height="300px" />
          </div>
          <div class="card" style="margin-top: 1rem">
            <p-table [value]="bestSelling()" dataKey="product_id">
              <ng-template pTemplate="header">
                <tr>
                  <th style="width:3rem">#</th><th>Product</th><th style="text-align:right">Qty Sold</th><th style="text-align:right">Revenue</th>
                </tr>
              </ng-template>
              <ng-template pTemplate="body" let-item let-i="rowIndex">
                <tr>
                  <td>{{ i + 1 }}</td>
                  <td class="font-medium">{{ item.name }}</td>
                  <td style="text-align:right">{{ item.total_quantity }}</td>
                  <td style="text-align:right">{{ item.total_revenue | phpCurrency }}</td>
                </tr>
              </ng-template>
            </p-table>
          </div>
        }
      </p-tabpanel>

      <p-tabpanel value="profit" header="Profit">
        <div class="report-controls">
          <p-select
            [(ngModel)]="profitPeriod"
            [options]="periodOptions"
            optionLabel="label"
            optionValue="value"
            (onChange)="onProfitPeriodChange()"
            appendTo="body"
          />
          <div class="date-nav">
            <p-button icon="pi pi-chevron-left" [text]="true" [rounded]="true" severity="secondary" (onClick)="navigateDate('profit', -1)" />
            <span class="date-label">{{ formatDateRange(profitReport()?.start_date, profitReport()?.end_date, profitPeriod) }}</span>
            <p-button icon="pi pi-chevron-right" [text]="true" [rounded]="true" severity="secondary" (onClick)="navigateDate('profit', 1)" [disabled]="isCurrentPeriod(profitDate, profitPeriod)" />
          </div>
          @if (isCurrentPeriod(profitDate, profitPeriod)) {
            <span class="current-badge">Current</span>
          }
        </div>

        @if (profitLoading()) {
          <div class="stats-grid">
            @for (_ of [1,2,3,4]; track _) {
              <div class="stat-card"><p-skeleton height="3.5rem" /></div>
            }
          </div>
        } @else if (profitReport()) {
          <div class="stats-grid">
            <div class="stat-card">
              <span class="stat-label">Revenue</span>
              <span class="stat-value">{{ profitReport()!.total_revenue | phpCurrency }}</span>
            </div>
            <div class="stat-card">
              <span class="stat-label">Cost</span>
              <span class="stat-value">{{ profitReport()!.total_cost | phpCurrency }}</span>
            </div>
            <div class="stat-card">
              <span class="stat-label">Gross Profit</span>
              <span class="stat-value" [class.success]="profitReport()!.gross_profit >= 0" [class.danger]="profitReport()!.gross_profit < 0">
                {{ profitReport()!.gross_profit | phpCurrency }}
              </span>
            </div>
            <div class="stat-card">
              <span class="stat-label">Margin</span>
              <span class="stat-value" [class.success]="profitReport()!.profit_margin >= 0" [class.danger]="profitReport()!.profit_margin < 0">
                {{ profitReport()!.profit_margin | number:'1.1-1' }}%
              </span>
            </div>
          </div>

          @if (profitReport()!.total_revenue === 0) {
            <div class="empty-state">
              <i class="pi pi-wallet"></i>
              <p>No profit data for this period</p>
            </div>
          }
        }
      </p-tabpanel>
    </p-tabs>
