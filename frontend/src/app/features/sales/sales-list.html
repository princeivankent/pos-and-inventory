<app-page-header title="Sales" subtitle="Sales history and transactions">
      <p-datepicker
        [(ngModel)]="selectedDate"
        [showIcon]="true"
        dateFormat="yy-mm-dd"
        placeholder="Filter by date"
        [showClear]="true"
        (onSelect)="loadSales()"
        (onClear)="loadSales()"
        inputStyleClass="date-input"
      />
    </app-page-header>

    <div class="card">
      <p-table
        [value]="sales()"
        [paginator]="true"
        [rows]="20"
        [loading]="loading()"
        dataKey="id"
        [sortField]="'sale_date'"
        [sortOrder]="-1"
      >
        <ng-template pTemplate="header">
          <tr>
            <th pSortableColumn="sale_number">Sale # <p-sortIcon field="sale_number" /></th>
            <th pSortableColumn="sale_date">Date <p-sortIcon field="sale_date" /></th>
            <th>Cashier</th>
            <th style="text-align:right">Items</th>
            <th pSortableColumn="total_amount" style="text-align:right">Total <p-sortIcon field="total_amount" /></th>
            <th>Payment</th>
            <th>Status</th>
            <th style="width:120px">Actions</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-sale>
          <tr>
            <td class="font-medium">{{ sale.sale_number }}</td>
            <td>{{ sale.sale_date | date:'MMM d, y h:mm a' }}</td>
            <td>{{ sale.cashier?.full_name ?? '-' }}</td>
            <td style="text-align:right">{{ sale.items?.length ?? 0 }}</td>
            <td style="text-align:right" class="font-semibold">{{ sale.total_amount | phpCurrency }}</td>
            <td>
              <app-status-badge
                [label]="sale.payment_method"
                [severity]="sale.payment_method === 'cash' ? 'success' : sale.payment_method === 'credit' ? 'warn' : 'info'"
              />
            </td>
            <td>
              <app-status-badge
                [label]="sale.status"
                [severity]="sale.status === 'completed' ? 'success' : sale.status === 'void' ? 'danger' : 'warn'"
              />
            </td>
            <td>
              <div class="flex gap-2">
                <p-button icon="pi pi-eye" [rounded]="true" [text]="true" (onClick)="viewSale(sale)" />
                @if (storeCtx.isAdmin() && sale.status === 'completed') {
                  <p-button icon="pi pi-ban" [rounded]="true" [text]="true" severity="danger" (onClick)="confirmVoid(sale)" pTooltip="Void sale" />
                }
              </div>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="8" class="empty-state">
              <div class="empty-content">
                <i class="pi pi-shopping-cart" style="font-size: 3rem; color: #d1d5db;"></i>
                <h3>No sales found</h3>
                <p class="text-secondary">
                  Sales will appear here when you complete transactions.
                </p>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>

    <!-- Sale Detail Dialog -->
    <p-dialog
      [(visible)]="detailVisible"
      header="Sale Detail"
      [modal]="true"
      [style]="{ width: '550px' }"
    >
      @if (selectedSale()) {
        <div class="sale-detail">
          <div class="detail-row">
            <span>Sale #</span>
            <strong>{{ selectedSale()!.sale_number }}</strong>
          </div>
          <div class="detail-row">
            <span>Date</span>
            <span>{{ selectedSale()!.sale_date | date:'MMM d, y h:mm a' }}</span>
          </div>
          <div class="detail-row">
            <span>Status</span>
            <app-status-badge
              [label]="selectedSale()!.status"
              [severity]="selectedSale()!.status === 'completed' ? 'success' : 'danger'"
            />
          </div>

          <h4 style="margin-top: 1rem">Items</h4>
          <table class="items-table">
            <thead>
              <tr>
                <th>Product</th>
                <th style="text-align:right">Qty</th>
                <th style="text-align:right">Price</th>
                <th style="text-align:right">Subtotal</th>
              </tr>
            </thead>
            <tbody>
              @for (item of selectedSale()!.items ?? []; track item.id) {
                <tr>
                  <td>{{ item.product?.name ?? 'Product' }}</td>
                  <td style="text-align:right">{{ item.quantity }}</td>
                  <td style="text-align:right">{{ item.unit_price | phpCurrency }}</td>
                  <td style="text-align:right">{{ item.subtotal | phpCurrency }}</td>
                </tr>
              }
            </tbody>
          </table>

          <div class="totals">
            <div class="detail-row">
              <span>Subtotal</span>
              <span>{{ selectedSale()!.subtotal | phpCurrency }}</span>
            </div>
            @if (selectedSale()!.tax_amount > 0) {
              <div class="detail-row">
                <span>VAT</span>
                <span>{{ selectedSale()!.tax_amount | phpCurrency }}</span>
              </div>
            }
            @if (selectedSale()!.discount_amount > 0) {
              <div class="detail-row">
                <span>Discount</span>
                <span>-{{ selectedSale()!.discount_amount | phpCurrency }}</span>
              </div>
            }
            <div class="detail-row total">
              <span>Total</span>
              <span>{{ selectedSale()!.total_amount | phpCurrency }}</span>
            </div>
            <div class="detail-row">
              <span>Paid</span>
              <span>{{ selectedSale()!.amount_paid | phpCurrency }}</span>
            </div>
            <div class="detail-row">
              <span>Change</span>
              <span>{{ selectedSale()!.change_amount | phpCurrency }}</span>
            </div>
          </div>
        </div>
      }
    </p-dialog>
